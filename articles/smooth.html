<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examples of fitting smooth trend DFA models • bayesdfa</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Examples of fitting smooth trend DFA models">
<meta property="og:description" content="bayesdfa">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bayesdfa</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/bayesdfa.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/bigdata.html">Examples of fitting DFA models with lots of data</a>
    </li>
    <li>
      <a href="../articles/combining_data.html">Combining data with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/compositional.html">Fitting compositional dynamic factor models with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/covariates.html">Examples of including covariates with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/estimate_process_sigma.html">Estimating process trend variability with bayesdfa</a>
    </li>
    <li>
      <a href="../articles/smooth.html">Examples of fitting smooth trend DFA models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/fate-ewi/bayesdfa/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="smooth_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Examples of fitting smooth trend DFA models</h1>
                        <h4 class="author">Eric J. Ward, Sean C. Anderson, Mary E. Hunsicker, Mike A. Litzow, Luis A. Damiano, Mark D. Scheuerell, Elizabeth E. Holmes, Nick Tolimieri</h4>
            
            <h4 class="date">2021-09-28</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/fate-ewi/bayesdfa/blob/master/vignettes/smooth.Rmd"><code>vignettes/smooth.Rmd</code></a></small>
      <div class="hidden name"><code>smooth.Rmd</code></div>

    </div>

    
    
<p>In addition to fitting conventional DFA models with trends modeled as random walks (or ARMA processes), we can also construct models where underlying trends are treated as smooth trends (B-splines, P-splines, or Gaussian processes).</p>
<p>Let’s load the necessary packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fate-ewi.github.io/bayesdfa/">bayesdfa</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan">rstan</a></span><span class="op">)</span>
<span class="va">chains</span> <span class="op">=</span> <span class="fl">1</span>
<span class="va">iter</span> <span class="op">=</span> <span class="fl">10</span></code></pre></div>
<div id="data-simulation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-simulation" class="anchor"></a>Data simulation</h2>
<p>The <code>sim_dfa</code> function normally simulates loadings <span class="math inline">\(\sim N(0,1)\)</span>, but here we will simulate time series that are more similar with loadings <span class="math inline">\(\sim N(1,0.1)\)</span></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_dfa.html">sim_dfa</a></span><span class="op">(</span>num_trends <span class="op">=</span> <span class="fl">1</span>, num_years <span class="op">=</span> <span class="fl">1000</span>, num_ts <span class="op">=</span> <span class="fl">4</span>,
            loadings_matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">4</span>, ncol <span class="op">=</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="fl">1</span>,
    <span class="fl">1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>, sigma<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">y_sim</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span></code></pre></div>
<p><img src="smooth_files/figure-html/unnamed-chunk-3-1.png" width="528"></p>
</div>
<div id="estimating-trends-as-b-splines" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-trends-as-b-splines" class="anchor"></a>Estimating trends as B-splines</h2>
<p>As a first approach, we can fit models where trends are estimated as B-splines. To do this, we change the <code>trend_model</code> argument, and specify the number of knots. More knots translates to smoother functions. For example,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">y_sim</span>, num_trends <span class="op">=</span> <span class="fl">1</span>, 
              trend_model <span class="op">=</span> <span class="st">"bs"</span>, n_knots <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></code></pre></div>
<p>Or for a model with more knots,</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">y_sim</span>, num_trends <span class="op">=</span> <span class="fl">1</span>, 
              trend_model <span class="op">=</span> <span class="st">"bs"</span>, n_knots <span class="op">=</span> <span class="fl">14</span><span class="op">)</span></code></pre></div>
</div>
<div id="estimating-trends-as-p-splines" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-trends-as-p-splines" class="anchor"></a>Estimating trends as P-splines</h2>
<p>Obviously, trends from the B-spline model are sensitive to the number of knots. As an alternative, we also allow trends to be modeled as penalized regression splines (“P-splines”). These methods are less sensitive to the numbers of knots, and only require the knots to be enough to adequately describe the wiggliness of the function.</p>
<p>We can fit these kinds of models by changing the <code>trend_model</code> argument</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">y_sim</span>, num_trends <span class="op">=</span> <span class="fl">1</span>, 
              trend_model <span class="op">=</span> <span class="st">"ps"</span>, n_knots <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></code></pre></div>
</div>
<div id="estimating-trends-as-gaussian-processes" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-trends-as-gaussian-processes" class="anchor"></a>Estimating trends as Gaussian processes</h2>
<p>Finally, another type of smoothing that can be done is treating the trends as Gaussian processes. Both full rank models (knots = time points) or predictive process models may be fit (fewer knots results in smoother functions). These types of models may be specified by again changing the <code>trend_model</code> argument,</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_dfa.html">fit_dfa</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">s</span><span class="op">$</span><span class="va">y_sim</span>, num_trends <span class="op">=</span> <span class="fl">1</span>, 
              trend_model <span class="op">=</span> <span class="st">"gp"</span>, n_knots <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></code></pre></div>
</div>
<div id="comparing-approaches" class="section level2">
<h2 class="hasAnchor">
<a href="#comparing-approaches" class="anchor"></a>Comparing approaches</h2>
<p>All of the smooth trend methods are flexible and able to capture the wiggliness of latent trends. Based on our experience, the B-spline and P-spline models will generally fit faster than the Gaussian predicitve process models (because they omit a critical matrix inversion step). The full rank Gaussian process models tend to be faster than the predictive process models. All of these approaches can be compared using cross validation, or similar predictive performance criterion.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Eric J. Ward, Sean C. Anderson, Luis A. Damiano, Michael J. Malick.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
